# 项目实施计划

## 1. 项目目标
构建一个部署在 Linux 服务器上的后端服务，包含数据库，用于定期抓取和存储 Instagram 的品牌营销活动数据，并提供 RESTful API 供外部快速查询。
*(注：Twitter/Facebook 模块后续待 Telegram 调试完成后再集成)*

## 2. 核心架构
*   **语言/框架**: Python 3 + FastAPI (提供 RESTful API)
*   **数据库**: **PostgreSQL** (需针对 1GB 内存环境进行配置优化，避免 OOM)。
*   **数据库管理**: **Alembic** (用于数据库版本控制和迁移)。
*   **爬虫/数据源**:
    *   **Instagram**: 基于 `instaloader` (改造为存入 DB)。
    *   *Twitter/Facebook (暂缓)*: 预留字段，待后续开发。
*   **静态资源服务**: FastAPI 自带的 `StaticFiles` 挂载本地目录，对外提供图片/视频访问 (`http://IP:PORT/static/...`)。
*   **调度器**: `APScheduler` (用于定时触发抓取任务)。

## 3. 项目目录结构
```text
BrandMonitor/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI 入口
│   ├── api/                 # API 路由
│   │   ├── __init__.py
│   │   ├── endpoints.py
│   │   └── models.py        # Pydantic 模型 (Request/Response)
│   ├── core/                # 核心配置
│   │   ├── __init__.py
│   │   ├── config.py
│   │   └── database.py      # DB 连接 session
│   ├── db/                  # 数据库相关
│   │   ├── __init__.py
│   │   └── models.py        # SQLAlchemy 模型 (Table定义)
│   ├── services/            # 业务逻辑
│   │   ├── __init__.py
│   │   ├── instagram.py     # Instaloader 封装
│   │   └── scheduler.py     # 定时任务管理
│   └── utils/
│       └── __init__.py
├── alembic/                 # Alembic 迁移脚本目录
├── static/                  # 静态资源 (图片/视频)
│   └── images/
│       └── instagram/
├── alembic.ini              # Alembic 配置
├── requirements.txt
├── Dockerfile
└── .env
```

## 4. 数据库设计 (Schema)

### 4.1 品牌表 (brands)
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | Integer | 主键 |
| name | String | 品牌名称 (如 "REMENT") |
| instagram_username | String | IG 用户名 |
| is_active | Boolean | 是否启用监控 (默认 True) |
| telegram_channel_id | String | (预留) TG 监控频道 ID |
| twitter_username | String | (预留) 关联 Twitter 用户名 |

### 4.2 帖子/活动表 (posts)
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| id | Integer | 主键 |
| brand_id | Integer | 外键 -> brands.id |
| platform | String | **'instagram'** (预留 'twitter', 'facebook') |
| original_id | String | 原始平台 ID (IG shortcode) |
| content_text | Text | 帖子文案/内容 |
| media_urls | Text | 本地图片/视频访问路径 (JSON 数组) |
| original_url | String | 原始链接 (用于溯源) |
| posted_at | DateTime | 发布时间 |
| created_at | DateTime | 抓取入库时间 |

## 5. 模块开发计划

### 5.1 基础架构搭建 (Infrastructure)
*   [ ] 创建项目目录结构。
*   [ ] 安装依赖 (`fastapi`, `uvicorn`, `sqlalchemy`, `psycopg2-binary`, `alembic`, `apscheduler`, `instaloader`).
*   [ ] 配置 `app/core/config.py` (读取 .env)。

### 5.2 数据库与模型层 (Database)
*   [ ] 编写 `app/db/models.py` (定义 Brand 和 Post 模型)。
*   [ ] 初始化 Alembic (`alembic init alembic`)。
*   [ ] 配置 `alembic/env.py` 以识别 SQLAlchemy 模型。
*   [ ] 生成并执行第一次迁移 (`alembic revision --autogenerate`, `alembic upgrade head`)。

### 5.3 爬虫服务 (Instagram Service)
*   [ ] 实现 `app/services/instagram.py`:
    *   封装 `instaloader` 逻辑。
    *   实现 `download_media` (下载到 `static/images/instagram/`).
    *   实现 `fetch_posts(brand_id, limit)`: 抓取数据 -> 存图 -> 写入 DB。

### 5.4 定时任务 (Scheduler)
*   [ ] 实现 `app/services/scheduler.py`:
    *   `update_instagram_brands()`: 轮询所有 active 的品牌。
    *   `cleanup_old_media()`: 自动清理过期文件。

### 5.5 API 接口开发 (API)
*   [ ] **GET /api/v1/posts**: 查库返回帖子列表 (支持 brand, date, limit 过滤)。
*   [ ] **POST /api/v1/brands**: 添加/管理品牌。

### 5.6 部署
*   [ ] 编写 `Dockerfile`。
*   [ ] 本地测试运行。

## 6. 下一步
*   开始执行 5.1 和 5.2，搭建目录并初始化数据库。
